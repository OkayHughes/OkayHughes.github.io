<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Explaining the weak laplacian in HOMME/CAM-SE | Owen K. Hughes </title> <meta name="author" content="Owen K. Hughes"> <meta name="description" content="The use of manifold-dependent tensors in the viscosity in SE the dynamical cores is tricky if you're most familiar with vector calculus. This post can help."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?v=a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?v=f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?v=62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?v=591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/wave.ico?v=f4ac2142a3b0b82c9658da568745e50e"> <link rel="stylesheet" href="/assets/css/main.css?v=d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://okayhughes.github.io/blog/2026/vector_lap/"> <script src="/assets/js/theme.js?v=a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?v=5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Owen</span> K. Hughes </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/presentations/">presentations </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Explaining the weak laplacian in HOMME/CAM-SE</h1> <p class="post-meta"> Created on January 14, 2026 </p> <p class="post-tags"> <a href="/blog/2026"> <i class="fa-solid fa-calendar fa-sm"></i> 2026 </a>   ·   <a href="/blog/tag/dycore-explainers"> <i class="fa-solid fa-hashtag fa-sm"></i> dycore-explainers</a>   ·   <a href="/blog/category/modeling-experts"> <i class="fa-solid fa-tag fa-sm"></i> modeling-experts</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="basic-principle">Basic principle:</h2> <p>Assume we’re calculating the Laplacian on a domain without boundary (true on sphere, ish)</p> <p>Recall A matrix \(A\) can be characterized by its action on an orthonormal basis, e.g. \(Ae_i = A_{:, i}\), \(e_i = (0, \ldots, \stackrel{i}{1}, ldots, 0)\), and that \(e_j^\top A e_i = A_{j,i}\) (i.e., we can extract the entries of a matrix by its action on “test vectors”.</p> <p>For this subroutine we recall that within an element, SE represents a scalar field as a sum \(u = \sum_{i,j=1}^{\textrm{npts}} a_{i,j} \phi_j(x)\phi_i(y)\), where \(\phi_k(x)\) is 1 at GLL point \(k\) and 0 at all other GLL points, and is a polynomial. <em>Spectral</em> derivatives are calculated by differentiating the \(\phi_k(x)\) <em>analytically</em> within the element, and then multiplying by a change of variables matrix (Dinv).</p> <p>To calculate a weak derivative, you multiply your desired function \(u\) by a “test function” \(v\) which you know to be nicer.</p> <p>Calculating the laplacian then looks like (assuming no boundary)</p> \[\begin{align*} \int (\nabla^2 u)v \intd{A} &amp;=\int (\nabla \cdot \nabla u) v {A} \\ &amp;= \stackrel{\textrm{boundary term}}{0} - \int \nabla v \cdot \nabla{u} \intd{A} \end{align*}\] <p>The weak formulation allows you to formulate a laplacian for \(u, v\) that have only first derivatives. Without performing element assembly (direct stiffness summation), \(\nabla u\) calculated by <code class="language-plaintext highlighter-rouge">gradient_sphere</code> will not be continuous at boundaries, and so \(\nabla \cdot \nabla u\) is not well defined. This is why <code class="language-plaintext highlighter-rouge">divergence_sphere_wk</code> is called.</p> <p>The intermediate code comes in three sections. The first conditional containing <code class="language-plaintext highlighter-rouge">grads(:,:,1) = grads(:,:,1)*mol_nu(:,:)</code> is for calculating molecular viscosity with a physically relevant nu. The second conditional containing <code class="language-plaintext highlighter-rouge">if (hypervis_power/=0 ) then</code> is for when hyperviscosity coefficients are determined at each grid point.</p> <p>The third conditional comes from an ad hoc redefinition of hyperviscosity that handles variable resolution. It is defined as \(\tilde{\nabla}^2u = \nabla \cdot V \nabla u\)</p> <p>There are several different methods for calculating \(V\) (none of which are physical, per se) but its purpose is to be able to input a constant value <code class="language-plaintext highlighter-rouge">nu_const</code> as, e.g., a namelist setting, and get reasonable hyperviscosity in a refined mesh.</p> <h2 id="notes-on-modifying-the-tensor">notes on modifying the tensor</h2> <p>Technically what we are computing is the Laplace-Beltrami operator, which in coordinates reads \(\nabla^2 f = \frac{1}{\sqrt{|g|}} \sum_{i}\sum_{j} \pder{}{x_i} \left(\sqrt{|g|} g^{i,j} \pder{f}{x_j} \right)\) , with \(g^{i,j}\) the inverse of the metric tensor.</p> <p>Let’s work using strong derivatives for the moment. Then let \(D^{-1}\) be the change-of-variables transformation as in the HOMME literature (contains cosine weighting). Let \(x_1, x_2\) be local coordinates in the reference element. Then \(\nabla^2 u = \frac{1}{\sqrt{|D^{\top}D|}} \begin{pmatrix}\pder{}{x_1} \\ \pder{}{x_2}\end{pmatrix}^\top \sqrt{|D^{\top}D|} D^{-\top}\left[D^{-1} \begin{pmatrix} \pder{f}{x_1} \\ \pder{f}{x_2} \end{pmatrix} \right].\) Recall that $D^{-\top}D^{-1}$ is precisely $g^{i,j}$ in the above expression, as a change-of-variables with Jacobian \(D\) induces a metric \(D^\top D\). The quantity in the brackets is what comes from <code class="language-plaintext highlighter-rouge">gradient_sphere</code>. When the tensorVisc quantity is used, it then reads as</p> <p>Then \(\nabla^2 u = \frac{1}{\sqrt{|D^{\top}D|}} \begin{pmatrix}\pder{}{x_1} \\ \pder{}{x_2}\end{pmatrix}^\top \sqrt{|D^{\top}D|} D^{-\top}V\left[D^{-1} \begin{pmatrix} \pder{f}{x_1} \\ \pder{f}{x_2} \end{pmatrix} \right].\)</p> <p>The construction of \(V\) (detailed in <code class="language-plaintext highlighter-rouge">cube_mod.F90</code>) then leads to \(\begin{align*} \nabla^2 u &amp;= \frac{1}{\sqrt{|D^{\top}D|}} \begin{pmatrix}\pder{}{x_1} \\ \pder{}{x_2}\end{pmatrix}^\top \sqrt{|D^{\top}D|} D^{-\top}D^\top E^{-\top}\Lambda^*\Lambda E^{-1} D\left[D^{-1} \begin{pmatrix} \pder{f}{x_1} \\ \pder{f}{x_2} \end{pmatrix} \right] \\ &amp;= \frac{1}{\sqrt{|D^{\top}D|}} \begin{pmatrix}\pder{}{x_1} \\ \pder{}{x_2}\end{pmatrix}^\top \sqrt{|D^{\top}D|} E^{-\top}\Lambda^*\Lambda E^{-1} \begin{pmatrix} \pder{f}{x_1} \\ \pder{f}{x_2} \end{pmatrix} \end{align*}\) where \(E\) diagonalizes \(D^\top D = E^\top \Lambda E\) and \(\Lambda^*\) is an ad-hoc diagonal matrix.</p> <h2 id="connection-between-laplacian-and-diffusion">Connection between laplacian and diffusion</h2> <p>In the momentum equation in Navier Stokes, the pressure gradient and diffusion terms both result from the Cauchy momentum equation \(\frac{\mathrm{D}\boldsymbol{v}}{\mathrm{D}t} = \frac{1}{\rho} \nabla \cdot \boldsymbol{\sigma}\), with the particular choice of stress tensor \(\boldsymbol{\sigma} = -p\boldsymbol{I} + \lambda \textrm{Tr}(\boldsymbol{\varepsilon})\boldsymbol{I} + 2\mu\boldsymbol{\varepsilon}\) with \(\boldsymbol{\varepsilon} = \frac{1}{2} \left(\nabla \boldsymbol{v} + (\nabla \boldsymbol{v}^\top) \right)\). The laplacian results from \(\nabla \cdot \mu \boldsymbol{\varepsilon} = \mu \nabla \cdot \nabla \boldsymbol{v}\).</p> <p>Here’s what we can conclude from this: the steps to design a reasonable tensor for your application should read something like this</p> <ul> <li>Transform to a tangent plane to the sphere using elem%lat in x-y coordinates (optional, but likely reduces mess when designing the stress tensor)</li> <li>Design a tensor \(\boldsymbol{V}(\Phi_s)\) that measures the “stress in the deformed configuration” (e.g. a Cauchy stress tensor)</li> <li>By using that tensor in laplacian_sphere_wk, your artificial diffusion will induce the time tendency necessary to relax the “deformed state” to a “reference state” with lower stress.</li> </ul> <p>The section on normal and shear stress in the <a href="https://en.wikipedia.org/wiki/Cauchy_stress_tensor#Normal_and_shear_stresses" rel="external nofollow noopener" target="_blank">Cauchy stress tensor wikipedia page</a> will be helpful for defining this.</p> <h2 id="bigger-picture">bigger picture:</h2> <p>I’m not entirely sure that laplacian is the right tool to use here, as it seems to me it would be an artificial source/sink of moisture. That seems pretty undesirable to have within the dycore. If you’re looking to penalize diffusion of moisture against topographic gradients, my first thought would be to identify the source of that diffusion and eliminate it, rather than make an ad hoc tool to cancel it out. You could also introduce artificial flow into the wind that’s used by tracer advection to counteract it, which I think would cause minor thermodynamic inconsistency.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/eulerian_split_form_advection/">Split form advection is neat.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/mhs_with_topo/">Moist Held Suarez with Topography</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/test/">What is this blog for?</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2026 Owen K. Hughes. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?v=a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?v=85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?v=2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?v=c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?v=c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?v=d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?v=6770a7377f8946aad71adf11ee4a75e6"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?v=2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?v=f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?v=a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?v=6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?v=6f508d74becd347268a7f822bca7309d"></script> </body> </html>